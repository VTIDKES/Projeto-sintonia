<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor Visual de Diagrama de Blocos</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11/dist/style.css">
    <script src="https://unpkg.com/streamlit-component-lib@2.0.0/dist/streamlit-component-lib.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            height: 100vh;
            overflow: hidden;
        }

        #root {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-section {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .toolbar-label {
            color: white;
            font-weight: 600;
            font-size: 13px;
            margin-right: 5px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-add {
            background: #10b981;
            color: white;
        }

        .btn-transfer {
            background: #3b82f6;
            color: white;
        }

        .btn-sum {
            background: #f59e0b;
            color: white;
        }

        .btn-gain {
            background: #8b5cf6;
            color: white;
        }

        .btn-integrator {
            background: #ec4899;
            color: white;
        }

        .btn-action {
            background: #ef4444;
            color: white;
        }

        .btn-utility {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .flow-container {
            flex: 1;
            background: #fafafa;
            position: relative;
        }

        .react-flow__node {
            border-radius: 8px;
            border: 2px solid #e5e7eb;
            background: white;
            padding: 12px 16px;
            font-size: 13px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 120px;
            transition: all 0.2s;
        }

        .react-flow__node:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #667eea;
        }

        .react-flow__node.selected {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .react-flow__node-transfer {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            border-color: #3b82f6;
        }

        .react-flow__node-sum {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
        }

        .react-flow__node-gain {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            border-color: #8b5cf6;
        }

        .react-flow__node-integrator {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border-color: #ec4899;
        }

        .react-flow__node-input,
        .react-flow__node-output {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border-color: #10b981;
        }

        .node-header {
            font-weight: 600;
            margin-bottom: 6px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .node-icon {
            width: 16px;
            height: 16px;
            display: inline-block;
        }

        .node-content {
            color: #6b7280;
            font-size: 12px;
        }

        .node-param {
            margin-top: 4px;
            font-family: 'Courier New', monospace;
            color: #374151;
            font-weight: 500;
        }

        .react-flow__edge-path {
            stroke: #667eea;
            stroke-width: 2;
        }

        .react-flow__edge.selected .react-flow__edge-path {
            stroke: #764ba2;
            stroke-width: 3;
        }

        .react-flow__handle {
            width: 10px;
            height: 10px;
            background: #667eea;
            border: 2px solid white;
        }

        .react-flow__handle-left {
            left: -5px;
        }

        .react-flow__handle-right {
            right: -5px;
        }

        .status-bar {
            background: white;
            padding: 8px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #6b7280;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useEffect, useRef } = React;
        const { ReactFlow, Controls, Background, MiniMap, useNodesState, useEdgesState, addEdge } = ReactFlowRenderer;

        let nodeIdCounter = 1;

        const CustomNode = ({ data }) => {
            return (
                <div>
                    <div className="node-header">
                        <span className="node-icon">{data.icon}</span>
                        <span>{data.label}</span>
                    </div>
                    {data.params && (
                        <div className="node-content">
                            <div className="node-param">{data.params}</div>
                        </div>
                    )}
                </div>
            );
        };

        const nodeTypes = {
            custom: CustomNode,
        };

        function FlowEditor() {
            const [nodes, setNodes, onNodesChange] = useNodesState([]);
            const [edges, setEdges, onEdgesChange] = useEdgesState([]);
            const reactFlowWrapper = useRef(null);
            const [reactFlowInstance, setReactFlowInstance] = useState(null);

            // Receber modelo inicial do Streamlit
            useEffect(() => {
                if (window.Streamlit) {
                    const onRender = (event) => {
                        const data = event.detail.args;
                        if (data && data.model) {
                            try {
                                const model = typeof data.model === 'string' ? JSON.parse(data.model) : data.model;
                                if (model.nodes && model.nodes.length > 0) {
                                    setNodes(model.nodes);
                                    setEdges(model.edges || []);
                                }
                            } catch (err) {
                                console.error('Erro ao parsear modelo:', err);
                            }
                        }
                    };

                    window.Streamlit.events.addEventListener(window.Streamlit.RENDER_EVENT, onRender);
                    window.Streamlit.setComponentReady();
                    window.Streamlit.setFrameHeight(700);

                    return () => {
                        window.Streamlit.events.removeEventListener(window.Streamlit.RENDER_EVENT, onRender);
                    };
                }
            }, []);

            // Enviar modelo atualizado para Streamlit
            const sendToStreamlit = useCallback((updatedNodes, updatedEdges) => {
                if (window.Streamlit) {
                    const model = {
                        nodes: updatedNodes,
                        edges: updatedEdges
                    };
                    window.Streamlit.setComponentValue(JSON.stringify(model));
                }
            }, []);

            const onConnect = useCallback((params) => {
                const newEdges = addEdge({ ...params, animated: true }, edges);
                setEdges(newEdges);
                sendToStreamlit(nodes, newEdges);
            }, [edges, nodes, sendToStreamlit]);

            const onNodesChangeWrapper = useCallback((changes) => {
                onNodesChange(changes);
                // Atualizar ap√≥s mudan√ßas
                setTimeout(() => {
                    sendToStreamlit(nodes, edges);
                }, 100);
            }, [onNodesChange, nodes, edges, sendToStreamlit]);

            const onEdgesChangeWrapper = useCallback((changes) => {
                onEdgesChange(changes);
                setTimeout(() => {
                    sendToStreamlit(nodes, edges);
                }, 100);
            }, [onEdgesChange, nodes, edges, sendToStreamlit]);

            const addNode = useCallback((type) => {
                const position = {
                    x: Math.random() * 400 + 100,
                    y: Math.random() * 300 + 100,
                };

                const nodeConfig = {
                    transfer: {
                        icon: 'üìä',
                        label: 'Fun√ß√£o de Transfer√™ncia',
                        params: 'num=[1], den=[1,1]',
                        className: 'transfer'
                    },
                    sum: {
                        icon: '‚ûï',
                        label: 'Somador',
                        params: 'sinais=[+1, +1]',
                        className: 'sum'
                    },
                    gain: {
                        icon: 'üìà',
                        label: 'Ganho',
                        params: 'K=1.0',
                        className: 'gain'
                    },
                    integrator: {
                        icon: '‚à´',
                        label: 'Integrador',
                        params: '1/s',
                        className: 'integrator'
                    },
                    input: {
                        icon: 'üì•',
                        label: 'Entrada',
                        params: '',
                        className: 'input'
                    },
                    output: {
                        icon: 'üì§',
                        label: 'Sa√≠da',
                        params: '',
                        className: 'output'
                    }
                };

                const config = nodeConfig[type] || nodeConfig.transfer;

                const newNode = {
                    id: `node_${nodeIdCounter++}`,
                    type: 'custom',
                    className: config.className,
                    position,
                    data: {
                        label: config.label,
                        icon: config.icon,
                        params: config.params,
                        blockType: type
                    },
                };

                const newNodes = [...nodes, newNode];
                setNodes(newNodes);
                sendToStreamlit(newNodes, edges);
            }, [nodes, edges, sendToStreamlit]);

            const clearAll = useCallback(() => {
                setNodes([]);
                setEdges([]);
                sendToStreamlit([], []);
            }, [sendToStreamlit]);

            const deleteSelected = useCallback(() => {
                const newNodes = nodes.filter(node => !node.selected);
                const newEdges = edges.filter(edge => !edge.selected);
                setNodes(newNodes);
                setEdges(newEdges);
                sendToStreamlit(newNodes, newEdges);
            }, [nodes, edges, sendToStreamlit]);

            return (
                <>
                    <div className="toolbar">
                        <div className="toolbar-section">
                            <span className="toolbar-label">Adicionar:</span>
                            <button className="btn btn-add" onClick={() => addNode('input')}>
                                üì• Entrada
                            </button>
                            <button className="btn btn-transfer" onClick={() => addNode('transfer')}>
                                üìä Transfer√™ncia
                            </button>
                            <button className="btn btn-sum" onClick={() => addNode('sum')}>
                                ‚ûï Somador
                            </button>
                            <button className="btn btn-gain" onClick={() => addNode('gain')}>
                                üìà Ganho
                            </button>
                            <button className="btn btn-integrator" onClick={() => addNode('integrator')}>
                                ‚à´ Integrador
                            </button>
                            <button className="btn btn-add" onClick={() => addNode('output')}>
                                üì§ Sa√≠da
                            </button>
                        </div>
                        <div className="toolbar-section" style={{marginLeft: 'auto'}}>
                            <button className="btn btn-action" onClick={deleteSelected}>
                                üóëÔ∏è Deletar
                            </button>
                            <button className="btn btn-utility" onClick={clearAll}>
                                üîÑ Limpar Tudo
                            </button>
                        </div>
                    </div>

                    <div className="flow-container" ref={reactFlowWrapper}>
                        <ReactFlow
                            nodes={nodes}
                            edges={edges}
                            onNodesChange={onNodesChangeWrapper}
                            onEdgesChange={onEdgesChangeWrapper}
                            onConnect={onConnect}
                            onInit={setReactFlowInstance}
                            nodeTypes={nodeTypes}
                            fitView
                            attributionPosition="bottom-left"
                        >
                            <Background color="#e5e7eb" gap={16} />
                            <Controls />
                            <MiniMap
                                nodeColor={(node) => {
                                    const colors = {
                                        transfer: '#3b82f6',
                                        sum: '#f59e0b',
                                        gain: '#8b5cf6',
                                        integrator: '#ec4899',
                                        input: '#10b981',
                                        output: '#10b981'
                                    };
                                    return colors[node.className] || '#6b7280';
                                }}
                            />
                        </ReactFlow>
                    </div>

                    <div className="status-bar">
                        <div className="status-item">
                            <div className="status-dot"></div>
                            <span>Pronto</span>
                        </div>
                        <div className="status-item">
                            <span>{nodes.length} blocos ‚Ä¢ {edges.length} conex√µes</span>
                        </div>
                        <div className="status-item">
                            <span>Arraste blocos para posicionar ‚Ä¢ Conecte pontos para criar rela√ß√µes</span>
                        </div>
                    </div>
                </>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FlowEditor />);
    </script>
</body>
</html>
